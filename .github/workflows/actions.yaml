name: "The New Norms Deployment"

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev
  workflow_dispatch:

env:
  NODE_VERSION: "20"

permissions:
  id-token: write
  security-events: write
  contents: read
  pull-requests: write
  actions: read

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      foldercheck: ${{ steps.changed-files.outputs.any_changed }}
      has_code_changes: ${{ steps.code-changes.outputs.any_changed }}
      has_dependency_changes: ${{ steps.dep-changes.outputs.any_changed }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #v5
        with:
          fetch-depth: 0

      - name: Check all changes
        id: changed-files
        uses: tj-actions/changed-files@24d32ffd492484c1d75e0c0b894501ddb9d30d62 #v47
        with:
          files: "**"
          since_last_remote_commit: true

      - name: Check code changes
        id: code-changes
        uses: tj-actions/changed-files@24d32ffd492484c1d75e0c0b894501ddb9d30d62 #v47
        with:
          files: |
            **/*.ts
            **/*.tsx
            **/*.js
            **/*.jsx
          since_last_remote_commit: true

      - name: Check dependency changes
        id: dep-changes
        uses: tj-actions/changed-files@24d32ffd492484c1d75e0c0b894501ddb9d30d62 #v47
        with:
          files: |
            **/package.json
            **/package-lock.json
            **/yarn.lock
          since_last_remote_commit: true

  secret_scan:
    runs-on: ubuntu-latest
    needs: check-changes
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #v5
        with:
          persist-credentials: false
          fetch-depth: 0

      - uses: ./.github/actions/secret-scans
        with:
          github_token_gitleaks: ${{ secrets.GITHUB_TOKEN }}
          gitleaks_license: ${{ secrets.GITLEAKS_LICENSE }}
          devsecops_slack_webhook: ${{ secrets.DEVSECOPS_SLACK_WEBHOOK }}
          current_branch: ${{ github.head_ref || github.ref_name }}
          commit_message: ${{ github.event.head_commit.message || github.event.pull_request.title }}

  dev_sast:
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.has_code_changes == 'true'
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #v5
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Get opengrep-rules commit SHAs
        id: commits
        shell: bash
        run: |
          # No token needed for public repos!
          get_sha() {
            curl -s "https://api.github.com/repos/opengrep/opengrep-rules/commits/$1" | jq -r '.sha'
          }
          echo "main_sha=$(get_sha main)" >> $GITHUB_OUTPUT

      - name: Clone opengrep-rules repository
        run: |
          # Clone the public repository without authentication
          git clone --depth 1 --branch main https://github.com/opengrep/opengrep-rules.git opengrep-rules

          echo "Main branch SHA: ${{ steps.commits.outputs.main_sha }}"

      - name: Run SAST scan
        uses: ./.github/actions/sast
        with:
          repository-name: ${{ github.repository }}
          sast-recommend-uri: ${{ secrets.SAST_RECOMMEND_URI }}
          deepseek_api_key: ${{ secrets.DEEPSEEK_API_KEY }}
          slack_channel: ${{ secrets.SLACK_CHANNEL }}
          slack_token: ${{ secrets.SLACK_TOKEN }}

  dev_sca:
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.has_dependency_changes == 'true'
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #v5
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Run SCA scan
        uses: ./.github/actions/sca
        with:
          repository-name: ${{ github.repository }}
          slack_channel: ${{ secrets.SLACK_CHANNEL }}
          slack_token: ${{ secrets.SLACK_TOKEN }}

  deploy-web:
    needs: [check-changes, dev_sca, secret_scan, dev_sast]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #v5
        with:
          fetch-depth: 0

      - name: Deploy to AWS
        run: echo "ðŸš€ Now we deploy!"